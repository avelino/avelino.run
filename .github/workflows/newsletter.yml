name: Newsletter on new post

on:
  push:
    branches: [main]
    paths:
      - "content/blog/**"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  send-broadcast:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history to ensure we can diff properly
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install deps
        run: |
          if [ -f package-lock.json ] || [ -f package.json ]; then
            npm ci || npm i --legacy-peer-deps || npm i
          else
            npm init -y
            npm i resend gray-matter --legacy-peer-deps
          fi
      - name: Send newsletter broadcast
        run: node .github/scripts/send_newsletter.mjs
        env:
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_BASE_SHA: ${{ github.event.before }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_AUDIENCE_ID: ${{ secrets.RESEND_AUDIENCE_ID }}
          NEWSLETTER_FROM: ${{ secrets.NEWSLETTER_FROM }}
          SITE_BASE_URL: ${{ secrets.SITE_BASE_URL }}
          SITE_NAME: avelino.run
      - name: Commit newsletter state
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          if [ -f .newsletter_state.json ]; then
            git add .newsletter_state.json
            # Check if there are changes to commit
            if ! git diff --staged --quiet; then
              echo "Committing newsletter state changes..."
              git commit -m "update newsletter state [skip ci]"
              # Pull before push to avoid conflicts
              git pull --rebase origin main || echo "Pull failed or no changes"
              git push origin main || echo "Push failed"
            else
              echo "No changes in newsletter state to commit"
            fi
          else
            echo "Warning: .newsletter_state.json not found"
          fi
